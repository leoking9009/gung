<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API 디버깅</title>
    <style>
        body {
            font-family: monospace;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
        }
        input, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        input {
            background: #3c3c3c;
            color: #d4d4d4;
        }
        button {
            background: #0e639c;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #1177bb;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #3c3c3c;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #569cd6; }
        h1 { color: #4ec9b0; }
        h3 { color: #569cd6; margin-top: 20px; }
        a { color: #4ec9b0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Gemini API 진단 도구</h1>

        <div style="background: #3c3c3c; padding: 15px; border-radius: 4px; margin: 15px 0;">
            <strong class="info">📝 API 키 발급 단계:</strong><br>
            1. <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> 접속<br>
            2. "Create API key" 클릭<br>
            3. "Create API key in new project" 선택<br>
            4. 생성된 키(AIza로 시작)를 복사<br>
            5. 아래에 붙여넣기
        </div>

        <input type="password" id="apiKey" placeholder="API 키 입력 (AIzaSy...)">

        <button onclick="runDiagnostics()">🚀 전체 진단 실행</button>

        <h3>📊 진단 결과:</h3>
        <div class="log" id="log">대기 중...</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'success': 'success',
                'error': 'error',
                'warning': 'warning',
                'info': 'info'
            }[type] || 'info';

            logDiv.innerHTML += `<span class="${color}">[${timestamp}] ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testModel(apiKey, version, model) {
            const url = `https://generativelanguage.googleapis.com/${version}/models/${model}:generateContent?key=${apiKey}`;

            log(`테스트 중: ${model} (${version})`, 'info');
            log(`URL: ${url.replace(apiKey, 'API_KEY')}`, 'info');

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: "안녕하세요" }]
                        }]
                    })
                });

                log(`응답 상태: ${response.status}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                log(`응답 데이터: ${JSON.stringify(data).substring(0, 200)}...`, 'info');

                if (response.ok) {
                    log(`✅ 성공! ${model} (${version}) - 응답: "${data.candidates[0].content.parts[0].text.substring(0, 50)}..."`, 'success');
                    return { success: true, model, version, data };
                } else {
                    log(`❌ 실패: ${model} - ${response.status} ${data.error?.message || JSON.stringify(data)}`, 'error');
                    return { success: false, model, version, status: response.status, error: data.error };
                }
            } catch (error) {
                log(`❌ 네트워크 오류: ${model} - ${error.message}`, 'error');
                return { success: false, model, version, error: error.message };
            }
        }

        async function checkApiKeyFormat(apiKey) {
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            log('1️⃣ API 키 형식 검사', 'warning');
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');

            if (!apiKey || apiKey.trim() === '') {
                log('❌ API 키가 비어있습니다', 'error');
                return false;
            }

            if (!apiKey.startsWith('AIza')) {
                log('⚠️ 경고: API 키가 AIza로 시작하지 않습니다', 'warning');
                log(`현재 시작 문자: ${apiKey.substring(0, 4)}`, 'warning');
            } else {
                log('✅ API 키 형식 정상 (AIza로 시작)', 'success');
            }

            log(`키 길이: ${apiKey.length}자`, 'info');
            return true;
        }

        async function testAllModels(apiKey) {
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            log('2️⃣ 모든 Gemini 모델 테스트', 'warning');
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');

            const models = [
                { version: 'v1beta', model: 'gemini-pro' },
                { version: 'v1beta', model: 'gemini-1.5-pro' },
                { version: 'v1beta', model: 'gemini-1.5-flash' },
                { version: 'v1beta', model: 'gemini-1.5-flash-latest' },
                { version: 'v1', model: 'gemini-1.5-pro' },
                { version: 'v1', model: 'gemini-1.5-flash' },
            ];

            const results = [];

            for (const { version, model } of models) {
                const result = await testModel(apiKey, version, model);
                results.push(result);
                await new Promise(resolve => setTimeout(resolve, 500)); // 0.5초 대기
            }

            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            log('3️⃣ 테스트 결과 요약', 'warning');
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');

            const successful = results.filter(r => r.success);
            const failed = results.filter(r => !r.success);

            if (successful.length > 0) {
                log(`✅ 성공한 모델: ${successful.length}개`, 'success');
                successful.forEach(r => {
                    log(`   - ${r.model} (${r.version})`, 'success');
                });

                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
                log('💡 권장 사항:', 'warning');
                log(`앱에서 사용할 모델: ${successful[0].model} (${successful[0].version})`, 'success');
            } else {
                log(`❌ 성공한 모델이 없습니다`, 'error');
            }

            if (failed.length > 0) {
                log(`❌ 실패한 모델: ${failed.length}개`, 'error');

                // 오류 패턴 분석
                const errors = failed.map(r => r.error?.message || r.error || 'Unknown');
                const uniqueErrors = [...new Set(errors)];

                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
                log('4️⃣ 오류 분석:', 'warning');
                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');

                uniqueErrors.forEach(err => {
                    log(`• ${err}`, 'error');
                });

                // 해결 방법 제안
                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
                log('🔧 해결 방법:', 'warning');
                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');

                if (uniqueErrors.some(e => e.includes('API key not valid') || e.includes('401'))) {
                    log('1. API 키를 다시 확인하세요', 'warning');
                    log('2. Google AI Studio에서 키를 삭제하고 새로 발급하세요', 'warning');
                    log('3. 키를 복사할 때 공백이 포함되지 않았는지 확인하세요', 'warning');
                }

                if (uniqueErrors.some(e => e.includes('not found') || e.includes('404'))) {
                    log('1. 해당 모델이 아직 사용 불가능할 수 있습니다', 'warning');
                    log('2. API 버전(v1/v1beta)을 확인하세요', 'warning');
                }

                if (uniqueErrors.some(e => e.includes('quota') || e.includes('429'))) {
                    log('1. 무료 할당량을 초과했습니다', 'warning');
                    log('2. 잠시 후 다시 시도하세요', 'warning');
                }
            }

            return successful.length > 0;
        }

        async function runDiagnostics() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = '';

            if (!await checkApiKeyFormat(apiKey)) {
                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
                log('⛔ 진단 중단: API 키를 입력해주세요', 'error');
                return;
            }

            log('', 'info');
            await testAllModels(apiKey);

            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            log('✅ 진단 완료', 'success');
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
        }
    </script>
</body>
</html>
